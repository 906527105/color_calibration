import unittest
import sys
import os
sys.path.append(r'./')
# print(sys.path)
from src.colorspace import *
from src.io_ import *
from src.api import *
# import src
import numpy as np
from skimage.color import colorconv
from src.color import *

src1 = np.array([[0.60536745, 0.80904457, 0.99723826],
       [0.37762899, 0.58338913, 0.7827993 ],
       [0.26318263, 0.45498298, 0.60474261],
       [0.17120167, 0.32539161, 0.4646073 ],
       [0.11438194, 0.22791906, 0.33972087],
       [0.04083411, 0.09811844, 0.15864528],
       [0.63635795, 0.28573217, 0.37335211],
       [0.60511026, 0.82916181, 0.38434705],
       [0.07748975, 0.67161848, 0.48383738],
       [0.00746649, 0.52906835, 0.99296555],
       [0.06601119, 0.14883879, 0.31867548],
       [0.52931895, 0.17376726, 0.55473953],
       [0.36398915, 0.25778938, 0.37859008],
       [0.46899249, 0.39365874, 0.39620359],
       [0.06996508, 0.48625302, 0.81571851],
       [0.38051002, 0.29311047, 0.6324333 ],
       [0.42952649, 0.50841677, 0.61546725],
       [0.33652318, 0.42416967, 0.51764706]])

src2 = np.array([[0.97794723, 0.99230211, 0.98770274],
       [0.69277464, 0.82761214, 0.96406124],
       [0.62979176, 0.76096671, 0.88511932],
       [0.54891905, 0.65731523, 0.78441428],
       [0.45192308, 0.55037707, 0.66598793],
       [0.27820728, 0.35245565, 0.4574043 ],
       [0.91391003, 0.45882353, 0.54634371],
       [0.98202614, 0.98458606, 0.516122  ],
       [0.43885918, 0.93951277, 0.65412953],
       [0.50599602, 0.81449275, 0.98778062],
       [0.31757703, 0.41323529, 0.60140056],
       [0.92962185, 0.44439776, 0.81407563],
       [0.6300346 , 0.45656286, 0.55109573],
       [0.83137255, 0.64670689, 0.59839115],
       [0.40139672, 0.73875907, 0.97980124],
       [0.76363148, 0.57808219, 0.91238249],
       [0.83150113, 0.80205722, 0.84731598],
       [0.76308746, 0.75624027, 0.79327731]])

src3 = np.array([[0.86900954, 0.88813163, 0.86360405],
       [0.68386965, 0.70240828, 0.67484116],
       [0.64638974, 0.64823344, 0.60882074],
       [0.54533469, 0.54448529, 0.51201826],
       [0.46845054, 0.45109342, 0.40970564],
       [0.35007187, 0.31970276, 0.25713666],
       [0.91030025, 0.38552083, 0.36753064],
       [0.94524563, 0.98856561, 0.02227142],
       [0.35004727, 0.79691701, 0.31906935],
       [0.40672136, 0.65939832, 0.93655959],
       [0.34242203, 0.3066219 , 0.32611298],
       [0.78043776, 0.28516872, 0.41378249],
       [0.71454745, 0.44534588, 0.4572549 ],
       [0.79459969, 0.54891088, 0.40638614],
       [0.39810377, 0.6278383 , 0.76421367],
       [0.73598506, 0.44560224, 0.59232493],
       [0.71603604, 0.58298887, 0.48685745],
       [0.65140181, 0.50980392, 0.32069066]])

src4 = np.array([[0.72779046, 0.82599356, 0.92578285],
       [0.59806468, 0.70648077, 0.79950344],
       [0.58185151, 0.68521631, 0.77058478],
       [0.53895617, 0.63518599, 0.72608852],
       [0.50251882, 0.58886213, 0.67807973],
       [0.40628116, 0.4734214 , 0.55006647],
       [0.82098994, 0.41969774, 0.47136356],
       [0.84498705, 0.92534221, 0.43924035],
       [0.39807817, 0.82884041, 0.54987664],
       [0.36334842, 0.71016591, 0.99636501],
       [0.37393965, 0.45289946, 0.59741343],
       [0.85809129, 0.4508014 , 0.7219917 ],
       [0.62554466, 0.4580719 , 0.52459695],
       [0.74401505, 0.58059736, 0.53523712],
       [0.37580511, 0.65467617, 0.86030897],
       [0.71044856, 0.54128391, 0.78446146],
       [0.76170123, 0.72412188, 0.73711384],
       [0.71108654, 0.71005455, 0.72077252]])

fileDict = {'imgs/1.jpg': src1,
       'imgs/2.jpg': src2,
       'imgs/3.jpg': src3,
       'imgs/4.jpg': src4}

ref = np.array([[  1.00000000e+02,   5.20000001e-03,  -1.04000000e-02],
       [  7.30833969e+01,  -8.19999993e-01,  -2.02099991e+00],
       [  6.24930000e+01,   4.25999999e-01,  -2.23099995e+00],
       [  5.04640007e+01,   4.46999997e-01,  -2.32399988e+00],
       [  3.77970009e+01,   3.59999985e-02,  -1.29700005e+00],
       [  0.00000000e+00,   0.00000000e+00,   0.00000000e+00],
       [  5.15880013e+01,   7.35179977e+01,   5.15690002e+01],
       [  9.36989975e+01,  -1.57340002e+01,   9.19420013e+01],
       [  6.94079971e+01,  -4.65940018e+01,   5.04869995e+01],
       [  6.66100006e+01,  -1.36789999e+01,  -4.31720009e+01],
       [  1.17110004e+01,   1.69799995e+01,  -3.71759987e+01],
       [  5.19739990e+01,   8.19440002e+01,  -8.40699959e+00],
       [  4.05489998e+01,   5.04399986e+01,   2.48490009e+01],
       [  6.08160019e+01,   2.60690002e+01,   4.94420013e+01],
       [  5.22529984e+01,  -1.99500008e+01,  -2.39960003e+01],
       [  5.12859993e+01,   4.84700012e+01,  -1.50579996e+01],
       [  6.87070007e+01,   1.22959995e+01,   1.62129993e+01],
       [  6.36839981e+01,   1.02930002e+01,   1.67639999e+01]])

color = Color(ref, Lab_D50_2)
colored = np.array([True, True, True, True, True, True, 
                    False, False, False, False, False, False, 
                    False, False, False, False, False, False, ])
color.colored = colored
color.grays = ~color.colored

def test(filename, savetag, series_tag, L=False, **kwargs):
    print(f"======={savetag}===========")
    img = cv2.imread(filename)
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)/255.
    src = fileDict[filename]
    ccm = color_calibration(src, color, **kwargs)
    
    # loss0 = ccm.loss(ccm.ccm0, True)
    # print("loss0: ", loss0)
    #ccm.value(100000)
    img = ccm.infer_image(filename, L)
    head, end = os.path.splitext(filename)
    cv2.imwrite(head + '_' + str(series_tag) + str(savetag) + end, img)    

def test_1(filename, series_tag='A'):
    test(filename, 1, series_tag, colorspace = sRGB)
    test(filename, 2, series_tag, colorspace = AdobeRGB, ccm_shape = '4x3')
    test(filename, 3, series_tag, colorspace = WideGamutRGB, linear='gray_polyfit', ccm_shape = '4x3')
    test(filename, 4, series_tag, colorspace = ProPhotoRGB, distance = 'rgbl', linear='gray_logpolyfit', deg = 3)
    test(filename, 5, series_tag, colorspace = DCI_P3_RGB, L=True, linear='identity', distance = 'rgb')
    test(filename, 6, series_tag, colorspace = AppleRGB, weights_coeff = 2, linear='color_polyfit', deg = 2)
    test(filename, 7, series_tag, colorspace = REC_2020_RGB, distance = 'de94', linear='color_logpolyfit', deg = 3)

if __name__ == "__main__":
    test_1('imgs/1.jpg')
    # test_1('imgs/2.jpg')
    # test_1('imgs/3.jpg')
    # test_1('imgs/4.jpg')
