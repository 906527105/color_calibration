# 色彩校正

色彩校正的目的是调整输入输出设备的颜色响应到已知状态。被校准的设备有时被称为*校准源* ; 用作标准的色彩空间有时也称为*校准目标*。

色彩校准已被许多行业使用，例如电视制作，游戏，摄影，工程，化学，医药等。

由于输入输出设备的制造工艺等，其通道响应存在非线性失真，为了较正该设备输出的图片，必须将其捕捉到的色彩与实际色彩进行校正。

## 校正色卡

通常使用的校准色彩叫做色卡（colorchecker），最著名的是麦克白色卡（Macbeth ColorChecker）。

该色卡是8 x11英寸英寸图表，由24个色块组成，具有18种熟悉的颜色和6个灰度级，灰度色卡的光密度为0.05至1.50。

![File:Gretag-Macbeth ColorChecker.jpg](https://upload.wikimedia.org/wikipedia/commons/a/ad/Gretag-Macbeth_ColorChecker.jpg)

## 校正矩阵

目前通常都使用线性矩阵近似来校正色彩空间，转换使用的矩阵被称为color correction matrix (CCM)。

CCM矩阵通常使用3×3矩阵和4×3矩阵，两者的区别在于是对色彩空间进行线性变换还是仿射变换。最早的论文通常使用仿射变换，但随着大家对相机内部机制越来越深入研究，现在大部分的论文都使用3×3矩阵进行模拟。

以下是3×3矩阵的ccm计算过程：

https://www.imatest.com/docs/colormatrix/

## 线性化

使用线性矩阵ccm来进行色彩校正的前提是输入输出的色彩空间都已经转换到与亮度成线性关系的空间中，否则ccm无法很好的建立输出输入图片之间的关系。

如果是相机RAW格式的图片，则输入图片无需进行线性化；如果是进行gamma校正过的图片，通常需要将其线性化，然后应用ccm矩阵。

通常线性化的方式有以下几种：

1. 无需线性化，对RAW格式图片成立；
2. 使用gamma校正。将输入图片使用gamma校正进行线性化。对于sRGB图片，可以进行不同的gamma校正，也可以使用其特有的线性化校正；
3. 使用多项式校正。通常使用3次方进行校正，将输入图片分解成r,g,b图，分别于线性化后的输出图片进行三次方近似，而后在使用ccm矩阵；

在输入图片线性化的同时，输出图片也要进行相应的线性化。通常情况下，输出的色卡空间已经线性化过了。

更多的线性化措施可见https://www.imatest.com/docs/colormatrix/。

## 饱和

当RGB数值足够大时，很可能是该数值超过了光源亮度而被截断了，因此其记录数值可能并非是实际数值，这种情况叫做色彩饱和。色彩饱和因为截断而产生非线性，因此通常需要将饱和色块排除出计算空间。

![colorchecker_saturated_density](背景知识4—色彩校正.assets/colorchecker_saturated_density.png)

## 损失函数

损失函数就是希望计算ccm矩阵中希望最小化的值，这函数指明了矩阵计算过程中的收敛方向。

通常ccm矩阵被定义成数据源经过线性化处理后，应用ccm矩阵的色彩与目标色彩之间的距离。色彩的距离通常采用Lab色彩空间的距离。有CIEDE1976，CIEDE1994，CIEDE2000等标准。在要求不高的情况下，也可以采用RGB空间的欧氏距离。

https://www.imatest.com/docs/colorcheck_ref/#colorerr

## 优化

通常使用非线性优化，极个别情况在要求不高的时候使用线性优化。

## 推断

当ccm矩阵计算完后，便可以应用其进行图片的推断。图片的推断需将原始图片进行线性化，然后应用ccm矩阵，然后进行反线性化（此处的反线性化并不一定和原始图片的线性化相反，而是与目标图片的线性化相反）。