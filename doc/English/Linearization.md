## Linearization

The first step in color correction is to linearize the measured data. Because the color space has not been calibrated, we usually use some empirical methods to linearize the color space. There are several methods of linearization which are commonly used empirically. One is to use gamma correction, the other is to use polynomial fitting. 

Linearization is generally an elementwise function . The mathematical symbols are as follows: 

$C$: any element of data in any channel of $R, G, B$. 

$R, G,  B$:  $R, G, and B$ channels respectively. 

$G$: gray scale; 

$s,sl$: subscript, which represents the measured data and its linearized value, the former is the input and the latter is the output;

$d,dl$: subscript, which represents the reference data and its linearized value



### Identical Transformation

No change is required during the Identical transformation linearization, because the channel value of the input RGB image is proportional to luminance. For example, if the input measurement data is in the RAW format, the measurement data is linearized, and therefore linearization is not required. 

An identity transformation formula is as follows: 

$$
C_{sl}=C_s 
$$

### Gamma Correction

Gamma correction is a means of performing nonlinearity in RGB space, and could be found in a color space document. In the linearization part, the value of $\gamma$ is usually set to 2.2. You can also customize the value. 

The formula for gamma correction linearization is as follows: 
$$
C_{sl}=C_s^{\gamma},\qquad C_s\ge0\\
C_{sl}=-(-C_s)^{\gamma},\qquad C_s<0\\\\
$$

### Polynomial Fitting

Polynomial fitting uses polynomials to linearize. Provided the polynomial what we used is:
$$
f(x)=a_nx^n+a_{n-1}x^{n-1}+... +a_0 
$$
Then: 
$$
C_{sl}=f(C_s)
$$
In practice, $n\le3$ is used to prevent overfitting. 

Polynomial fitting has many variants, the key is how to generate $f(x)$. Generally, linearized reference data and corresponding measurement data need to be used to calculate a parameter of the polynomial, but not all channels can participate in calculation. Generally, the saturation measurement data needs to be removed. See the algorithm introduction document in details.

#### Fitting of RGB Three Polynomials

The RGB three-channel uses different polynomials[1-3], that is, the goal is to generate three polynomials, $r(x), g(x), b(x)$, which are used for linearization:
$$
R_{sl}=r(R_s)\\
G_{sl}=g(G_s)\\
B_{sl}=b(B_s)\\
$$
The polynomial is generated by minimizing the minimum variance between the measured data and the linearized reference data, taking the R-channel as an example:

$$
R=\arg min_{f}(\Sigma(R_{dl}-f(R_S)^2)
$$

It's equivalent to finding the least variance regression for all the equations of reference colors, that is:
$$
f(R_{s1})=R_{dl1}\\
f(R_{s2})=R_{dl2}\\
...
$$

With a polynomial, the regression equation becomes:
$$
\begin{bmatrix}
R_{s1}^{n} & R_{s1}^{n-1} & ... & 1\\ 
R_{s2}^{n} & R_{s2}^{n-1} & ... & 1\\ 
... & ... & ... & ...
\end{bmatrix}
\begin{bmatrix}
a_{n}\\ 
a_{n-1}\\ 
... \\
a_0
\end{bmatrix}
=
\begin{bmatrix}
R_{dl1}\\ 
R_{dl2}\\ 
... 
\end{bmatrix}
$$
Ultimately, it can be expressed as a system of linear equations:

$$
AX=B
$$

When the number of reference colors is  â‰¥n, the linear system has a least-squares solution:

$$
X=(A^TA)^{-1}A^TBr
$$

Once we get the polynomial coefficients, we can get the polynomial r.

This method of finding polynomial coefficients can be implemented by numpy.polyfit in numpy, That is:

$$
R=polyfit(R_S, R_{dl})
$$

Note that, in general, the polynomial that we want to obtain is guaranteed to monotonically increase in the [0,1] . But this means that nonlinear methods are needed to generate polynomials(see [4] in detail). This undoubtedly greatly increases the complexity of the program. And monotonicity or not does not affect the correct operation of the color correction program, so in the end, polyfit is still used to implement the program.

Parameters for other channels can also be derived in a similar way.

#### Gray Polynomial Fitting

In this method[2], a polynomial is used for all channels. The polynomial is the optimal result from minimizing the measurement data to linearizing the reference data. However, only the black-and-white gray data in the reference data is left, and the colored data is discarded.

The measurement data corresponding to the gray scale in the reference data is not necessarily gray, so it is have to gray the measurement data. Gray scale refers to the Y channel of the XYZ color space. The color space of the measurement data is not determined and cannot be converted into the XYZ space. Therefore, the sRGB formula is used to approximate[5]. 
$$
G_{sl}=0.2126R_{sl}+0.7152G_{sl}+0.0722B_{sl} 
$$
Here, the polynomial parameters can be obtained by using the polyfit. 
$$
f=polyfit(G_{sl}, G_{dl}) 
$$
After $f$ is obtained, linearization can be performed. 

#### Logarithmic Polynomial Fitting

For gamma correction, we take the logarithm: 
$$
ln(C_{sl})={\gamma}ln(C_s),\qquad C_s\ge0\ 
$$
It can be seen that there is a linear relationship between $ln(C_s)$ and $ln(C_{sl})$. It can be considered that the formula is an approximation of a polynomial relationship, that is, the polynomial $f$ exists, so we have[2]:
$$
ln(C_{sl})=f(ln(C_s)), \qquad C_s>0\\
C_{sl}=0, \qquad C_s=0
$$

Because $exp(ln(0))\to\infin$, the channel whose component is 0 is directly corresponding to 0 in the formula above.

For three RGB polynomial fitting, we have:
$$
r=polyfit(ln(R_s),ln(R_{dl}))\\
g=polyfit(ln(G_s),ln(G_{dl}))\\
b=polyfit(ln(B_s),ln(B_{dl}))\\
$$
Note that the parameter of $ln$ cannot be 0. Therefore, we need to delete the channels whose values are 0 from $R_s$ and $R_{dl}$. 

Therefore: 

$$
ln(R_{sl})=r(ln(R_s)), \qquad R_s>0\\
R_{sl}=0, \qquad R_s=0\\
ln(G_{sl})=g(ln(G_s)),\qquad G_s>0\\
G_{sl}=0, \qquad G_s=0\\
ln(B_{sl})=b(ln(B_s)),\qquad B_s>0\\
B_{sl}=0, \qquad B_s=0\\
$$

Because of $exp(ln(0))\to\infin$, the channel with the component 0 directly corresponds to 0. 

For the gray polynomial, the following is also obtained: 
$$
f=polyfit(ln(G_{sl}),ln(G_{dl}))
$$
Linearization: 
$$
ln(C_{sl})=f(ln(C_s)), \qquad C_s>0\\
C_sl=0, \qquad C_s=0
$$

## References

1. http://www.its.bldrdoc.gov/pub/ntia-rpt/04-406/
2. https://www.imatest.com/docs/colormatrix/
3. http://im.snibgo.com/col2mp.htm
4. https://math.stackexchange.com/questions/60610/polynomial-fitting-where-polynomial-must-be-monotonically-increasing
5. https://en.wikipedia.org/wiki/Grayscale

